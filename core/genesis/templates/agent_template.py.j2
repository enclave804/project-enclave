"""
{{ agent_name }} â€” Dynamically generated agent for {{ vertical_name }}.

Goal: {{ agent_goal }}

Generated by: Genesis Engine Agent Factory (v2)
Generated at: {{ generated_at }}

Architecture:
    {{ graph_description }}

WARNING: This file was auto-generated. Modify with care.
    Re-generation will overwrite manual changes.
    Use the agent YAML config (params) for customization.
"""

from __future__ import annotations

import logging
from typing import Any, Optional, Type

from core.agents.base import BaseAgent
from core.agents.contracts import InsightData
from core.agents.registry import register_agent_type
from core.agents.state import BaseAgentState
from core.config.agent_schema import AgentInstanceConfig

logger = logging.getLogger(__name__)


# ---------------------------------------------------------------------------
# State Definition
# ---------------------------------------------------------------------------

class {{ state_class_name }}(BaseAgentState, total=False):
    """State for {{ agent_name }}."""
{% for field in state_fields %}
    {{ field.name }}: {{ field.type }}  # {{ field.description }}
{% endfor %}


# ---------------------------------------------------------------------------
# Agent Implementation
# ---------------------------------------------------------------------------

@register_agent_type("{{ agent_type }}")
class {{ class_name }}(BaseAgent):
    """
    {{ agent_description }}

    Nodes:
{% for node in graph_nodes %}
        {{ loop.index }}. {{ node.name }} â€” {{ node.description }}
{% endfor %}
    """

    def build_graph(self) -> Any:
        """Build the {{ agent_name }}'s LangGraph state machine."""
        from langgraph.graph import StateGraph, END

        workflow = StateGraph({{ state_class_name }})

        # Add nodes
{% for node in graph_nodes %}
        workflow.add_node("{{ node.name }}", self._node_{{ node.name }})
{% endfor %}

        # Set entry point
        workflow.set_entry_point("{{ graph_nodes[0].name }}")

        # Add edges
{% for edge in graph_edges %}
{% if edge.conditional %}
        workflow.add_conditional_edges(
            "{{ edge.source }}",
            self._route_{{ edge.source }},
            {{ edge.condition_map }},
        )
{% else %}
        workflow.add_edge("{{ edge.source }}", {{ edge.target }})
{% endif %}
{% endfor %}

        # Compile with optional checkpointer and human gates
        compile_kwargs: dict[str, Any] = {}
        if self.checkpointer:
            compile_kwargs["checkpointer"] = self.checkpointer

        human_gates = self.config.human_gates
        if human_gates.enabled and human_gates.gate_before:
            compile_kwargs["interrupt_before"] = human_gates.gate_before

        return workflow.compile(**compile_kwargs)

    def get_tools(self) -> list[Any]:
        """Return tools from MCP config."""
        return self.mcp_tools

    def get_state_class(self) -> Type[{{ state_class_name }}]:
        return {{ state_class_name }}

    # --- State Preparation ---

    def _prepare_initial_state(
        self, task: dict[str, Any], run_id: str
    ) -> dict[str, Any]:
        state = super()._prepare_initial_state(task, run_id)
        state.update({
{% for field in state_fields %}
            "{{ field.name }}": {{ field.default }},
{% endfor %}
        })
        return state

    # --- Node Implementations ---
{% for node in graph_nodes %}

    async def _node_{{ node.name }}(
        self, state: {{ state_class_name }}
    ) -> dict[str, Any]:
        """
        {{ node.description }}
        """
{{ node.implementation | indent(8, first=True) }}
{% endfor %}
{% for edge in graph_edges %}
{% if edge.conditional %}

    def _route_{{ edge.source }}(
        self, state: {{ state_class_name }}
    ) -> str:
        """Route from {{ edge.source }} based on state."""
{{ edge.routing_logic | indent(8, first=True) }}
{% endif %}
{% endfor %}

    # --- Knowledge Writing ---

    async def write_knowledge(self, result: dict[str, Any]) -> None:
        """Write agent results back to the shared brain."""
{{ knowledge_writing_logic | indent(8, first=True) }}

    def __repr__(self) -> str:
        return (
            f"<{{ class_name }} "
            f"agent_id={self.agent_id!r} "
            f"vertical={self.vertical_id!r}>"
        )
